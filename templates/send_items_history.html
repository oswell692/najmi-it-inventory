{% extends "base.html" %}

{% block title %}Send Items History - Najmi International{% endblock %}

{% block content %}
<style>
    /* Remove page scroll, keep only table scroll */
    body, html {
        overflow: hidden;
        height: 100%;
    }
    
    .container-fluid {
        height: calc(100vh - 70px);
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }
    
    /* Make the table section take remaining space */
    .row:last-child {
        flex: 1;
        min-height: 0;
    }
    
    .row:last-child .col-12 {
        height: 100%;
    }
    
    .row:last-child .card {
        height: 100%;
        display: flex;
        flex-direction: column;
    }
    
    .row:last-child .card-body {
        flex: 1;
        min-height: 0;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        padding: 0 !important;
    }
    
    /* Main table container - takes most space but leaves room for footer */
    .table-main-container {
        flex: 1;
        min-height: 0;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }
    
    /* Custom table container for sticky headers */
    .table-container {
        flex: 1;
        overflow: auto;
        position: relative;
    }
    
    /* Footer container - fixed height */
    .table-footer {
        flex-shrink: 0;
        padding: 15px 0;
        border-top: 1px solid #e9ecef;
        background: white;
    }
    
    /* Make table header fixed with proper styling */
    #historyTable {
        margin-bottom: 0;
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
    }
    
    #historyTable thead th {
        position: sticky;
        top: 0;
        background: #f8f9fa;
        z-index: 10;
        border-bottom: 2px solid #dee2e6;
        box-shadow: 0 2px 3px rgba(0,0,0,0.1);
        padding: 12px 8px;
        vertical-align: middle;
    }
    
    #historyTable tbody td {
        padding: 12px 8px;
        vertical-align: middle;
    }
    
    /* Number column styling */
    #historyTable thead th:first-child {
        width: 50px;
        text-align: center;
        background: #f8f9fa;
    }
    
    #historyTable tbody td:first-child {
        width: 50px;
        text-align: center;
        font-weight: bold;
        color: #495057;
        background: white;
    }
    
    /* Ensure thead has proper background when sticky */
    #historyTable thead {
        position: sticky;
        top: 0;
        z-index: 10;
    }
</style>

<div class="container-fluid">
    <div class="row">
      <div class="col-12">
        <div class="d-flex justify-content-between align-items-center py-3">
          <div>
            <h2 class="mb-1 fw-bold text-dark">
              <i class="fas fa-history me-2"></i>Sent Items History
            </h2>
            <p class="text-muted mb-0">Track all item transfers between stations</p>
          </div>
          <div class="d-flex gap-2">
            <a href="{{ url_for('admin.admin_dashboard') }}" class="btn btn-outline-secondary">
              <i class="fas fa-arrow-left me-2"></i>Dashboard
            </a>
            <a href="{{ url_for('admin.send_items') }}" class="btn btn-primary">
              <i class="fas fa-plus-circle me-2"></i>New Send
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- Stats Overview -->
    <div class="row">
      <div class="col-xl-3 col-md-6 mb-3">
        <div class="card history-card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h4 class="card-title text-primary">{{ send_history|length }}</h4>
                <p class="card-text text-muted mb-0">Total Transfers</p>
              </div>
              <div class="bg-primary bg-opacity-10 p-3 rounded">
                <i class="fas fa-exchange-alt text-primary" style="font-size: 1.5rem;"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-xl-3 col-md-6 mb-3">
        <div class="card history-card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h4 class="card-title text-warning">
                  {{ send_history|selectattr('status', 'equalto', 'sent')|list|length }}
                </h4>
                <p class="card-text text-muted mb-0">In Transit</p>
              </div>
              <div class="bg-warning bg-opacity-10 p-3 rounded">
                <i class="fas fa-truck text-warning" style="font-size: 1.5rem;"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-xl-3 col-md-6 mb-3">
        <div class="card history-card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h4 class="card-title text-success">
                  {{ send_history|selectattr('status', 'equalto', 'received')|list|length }}
                </h4>
                <p class="card-text text-muted mb-0">Received</p>
              </div>
              <div class="bg-success bg-opacity-10 p-3 rounded">
                <i class="fas fa-check-circle text-success" style="font-size: 1.5rem;"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-xl-3 col-md-6 mb-3">
        <div class="card history-card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h4 class="card-title text-info">
                  {% set total_items = namespace(value=0) %}
                  {% for send in send_history %}
                    {% set total_items.value = total_items.value + send.item_count %}
                  {% endfor %}
                  {{ total_items.value }}
                </h4>
                <p class="card-text text-muted mb-0">Total Items</p>
              </div>
              <div class="bg-info bg-opacity-10 p-3 rounded">
                <i class="fas fa-boxes text-info" style="font-size: 1.5rem;"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Filters -->
    <div class="row">
      <div class="col-12">
        <div class="card history-card">
          <div class="card-body py-3">
            <div class="row g-2 align-items-center">
              <div class="col-md-3">
                <label class="form-label small text-muted mb-1">Filter by Status</label>
                <select class="form-select form-select-sm" id="statusFilter">
                  <option value="all">All Status</option>
                  <option value="sent">In Transit</option>
                  <option value="received">Received</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label small text-muted mb-1">Filter by Station</label>
                <select class="form-select form-select-sm" id="stationFilter">
                  <option value="all">All Stations</option>
                  {% for station in stations %}
                  <option value="{{ station.name }}">{{ station.name }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label small text-muted mb-1">Search</label>
                <input type="text" class="form-control form-control-sm" id="searchInput" placeholder="Search by item, person, ID...">
              </div>
              <div class="col-md-2">
                <label class="form-label small text-muted mb-1">&nbsp;</label>
                <button class="btn btn-outline-secondary btn-sm w-100" onclick="clearFilters()">
                  <i class="fas fa-rotate-left me-1"></i>Clear
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Send History Table -->
    <div class="row">
      <div class="col-12">
        <div class="card history-card">
          <div class="card-body">
            {% if send_history %}
            <div class="table-main-container">
              <div class="table-container">
                <table class="table table-hover" id="historyTable">
                  <thead>
                    <tr>
                      <th>#</th>
                      <th>Transfer Info</th>
                      <th>Items</th>
                      <th>Persons</th>
                      <th>Delivery Dates</th>
                      <th>Status</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for send in send_history %}
                    <tr class="history-row {% if send.status == 'sent' %}status-sent{% else %}status-received{% endif %}" 
                        data-status="{{ send.status }}"
                        data-from-station="{{ send.from_station_name }}"
                        data-to-station="{{ send.to_station_name }}"
                        data-search="{{ send.id }} {{ send.sent_by }} {{ send.received_by or '' }} {{ send.from_station_name }} {{ send.to_station_name }}">
                      <td>{{ loop.index }}</td>
                      <td>
                        <div class="d-flex align-items-center">
                          <div class="flex-shrink-0">
                            {% if send.status == 'sent' %}
                            <i class="fas fa-truck text-warning me-2"></i>
                            {% else %}
                            <i class="fas fa-check-circle text-success me-2"></i>
                            {% endif %}
                          </div>
                          <div class="flex-grow-1">
                            <strong class="d-block">{{ send.from_station_name }}</strong>
                            <i class="fas fa-arrow-right text-muted small mx-1"></i>
                            <strong class="d-block">{{ send.to_station_name }}</strong>
                            <small class="text-muted">ID: #{{ send.id }}</small>
                          </div>
                        </div>
                      </td>
                      <td>
                        <span class="badge bg-primary">{{ send.item_count }} items</span>
                        <br>
                        <small class="text-muted">Sent: {{ send.send_date.strftime('%b %d, %Y') }}</small>
                      </td>
                      <td>
                        <small>
                          <strong class="d-block">Sent by:</strong>
                          {{ send.sent_by }}
                          {% if send.received_by %}
                          <br>
                          <strong class="d-block mt-1">Received by:</strong>
                          {{ send.received_by }}
                          {% endif %}
                        </small>
                      </td>
                      <td>
                        <small>
                          {% if send.expected_delivery_date %}
                            {# Safe date comparison #}
                            {% set today_date = now.date() %}
                            {% set expected_date = send.expected_delivery_date %}
                            {% set date_class = "date-normal" %}
                            
                            {% if send.status == 'sent' and expected_date %}
                              {% if expected_date < today_date %}
                                {% set date_class = "date-overdue" %}
                              {% elif expected_date == today_date %}
                                {% set date_class = "date-upcoming" %}
                              {% endif %}
                            {% endif %}
                            
                            <span class="{{ date_class }}">
                              <i class="fas fa-calendar-alt me-1"></i>
                              Expected: {{ expected_date.strftime('%b %d, %Y') }}
                            </span>
                            <br>
                          {% endif %}
                          
                          {% if send.received_date %}
                            <span class="text-success">
                              <i class="fas fa-calendar-check me-1"></i>
                              Received: {{ send.received_date.strftime('%b %d, %Y') }}
                            </span>
                          {% else %}
                            <span class="text-muted">
                              <i class="far fa-calendar-times me-1"></i>
                              Not received yet
                            </span>
                          {% endif %}
                        </small>
                      </td>
                      <td>
                        {% if send.status == 'sent' %}
                        <span class="badge bg-warning">
                          <i class="fas fa-truck me-1"></i>In Transit
                        </span>
                        {% if send.expected_delivery_date and send.expected_delivery_date < now.date() %}
                        <br>
                        <small class="date-overdue mt-1 d-block">
                          <i class="fas fa-exclamation-triangle me-1"></i>Overdue
                        </small>
                        {% endif %}
                        {% else %}
                        <span class="badge bg-success">
                          <i class="fas fa-check-circle me-1"></i>Received
                        </span>
                        {% endif %}
                      </td>
                      <td>
                        <div class="btn-group btn-group-sm">
                          <a href="{{ url_for('admin.send_items_details', send_id=send.id) }}" 
                             class="btn btn-outline-primary" title="View Details">
                            <i class="fas fa-eye me-1"></i>View
                          </a>
                          {% if send.status == 'sent' %}
                          <button type="button" class="btn btn-outline-success" 
                                  onclick="markAsReceived({{ send.id }})"
                                  title="Mark Received">
                            <i class="fas fa-check me-1"></i>Receive
                          </button>
                          {% endif %}
                          <!-- EDIT BUTTON -->
                          <a href="{{ url_for('admin.edit_send_items', send_id=send.id) }}" 
                             class="btn btn-outline-warning" title="Edit">
                            <i class="fas fa-edit me-1"></i>Edit
                          </a>
                          <!-- DELETE BUTTON -->
                          <form action="{{ url_for('admin.delete_send_items', send_id=send.id) }}" 
                                method="POST" class="d-inline" 
                                onsubmit="return confirmDeleteSendItem()">
                            <button type="submit" class="btn btn-outline-danger" title="Delete">
                              <i class="fas fa-trash me-1"></i>Delete
                            </button>
                          </form>
                        </div>
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
              
              <!-- Results Count - Now inside its own container -->
              <div class="table-footer">
                <div class="d-flex justify-content-between align-items-center">
                  <small class="text-muted" id="resultsCount">
                    Showing {{ send_history|length }} of {{ send_history|length }} records
                  </small>
                  <div>
                    <small class="text-muted me-3">
                      <i class="fas fa-circle text-warning me-1"></i>In Transit
                    </small>
                    <small class="text-muted">
                      <i class="fas fa-circle text-success me-1"></i>Received
                    </small>
                  </div>
                </div>
              </div>
            </div>
            {% else %}
            <div class="text-center py-5">
              <i class="fas fa-exchange-alt display-1 text-muted"></i>
              <h5 class="mt-3 text-muted">No Send Records</h5>
              <p class="text-muted mb-4">No sent items have been recorded yet</p>
              <a href="{{ url_for('admin.send_items') }}" class="btn btn-primary">
                <i class="fas fa-plus-circle me-2"></i>Create First Send
              </a>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Mark as Received Modal -->
  <div class="modal fade" id="receiveModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Mark Items as Received</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <form id="receiveForm" method="POST" enctype="multipart/form-data">
          <div class="modal-body">
            <p>Are you sure you want to mark these items as received?</p>
            
            <div class="mb-3">
              <label for="receivedBy" class="form-label">Received By</label>
              <input type="text" class="form-control" id="receivedBy" name="received_by" 
                     placeholder="Enter name of person receiving items" required>
            </div>
            
            <div class="mb-3">
              <label for="receivedDate" class="form-label">Actual Received Date</label>
              <input type="date" class="form-control" id="receivedDate" name="received_date" required>
            </div>
            
            <div class="mb-3">
              <label for="receivingPhotos" class="form-label">Receiving Photos 
                <span class="badge bg-secondary optional-badge">Optional</span>
              </label>
              <input type="file" class="form-control" id="receivingPhotos" 
                     name="receiving_photos" accept="image/*" multiple>
              <small class="text-muted">Upload photos of items upon receipt (Max 5MB each)</small>
            </div>
            
            <div class="mb-3">
              <label for="receiveNotes" class="form-label">Receiving Notes (Optional)</label>
              <textarea class="form-control" id="receiveNotes" name="receive_notes" rows="3" 
                        placeholder="Any notes about the receiving process..."></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-success">Confirm Receipt</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    let currentSendId = null;

    function markAsReceived(sendId) {
      currentSendId = sendId;
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('receivedDate').value = today;
      document.getElementById('receiveForm').action = `/admin/mark_items_received/${sendId}`;
      new bootstrap.Modal(document.getElementById('receiveModal')).show();
    }

    function confirmDeleteSendItem() {
      return confirm('Are you sure you want to delete this send record? This action cannot be undone.');
    }

    function filterTable() {
      const statusFilter = document.getElementById('statusFilter').value;
      const stationFilter = document.getElementById('stationFilter').value;
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      
      const rows = document.querySelectorAll('#historyTable tbody .history-row');
      let visibleCount = 0;
      
      rows.forEach(row => {
        const status = row.getAttribute('data-status');
        const fromStation = row.getAttribute('data-from-station');
        const toStation = row.getAttribute('data-to-station');
        const searchData = row.getAttribute('data-search').toLowerCase();
        
        let showRow = true;
        
        // Status filter
        if (statusFilter !== 'all' && status !== statusFilter) {
          showRow = false;
        }
        
        // Station filter
        if (stationFilter !== 'all' && fromStation !== stationFilter && toStation !== stationFilter) {
          showRow = false;
        }
        
        // Search filter
        if (searchTerm && !searchData.includes(searchTerm)) {
          showRow = false;
        }
        
        if (showRow) {
          row.style.display = '';
          visibleCount++;
        } else {
          row.style.display = 'none';
        }
      });
      
      document.getElementById('resultsCount').textContent = `Showing ${visibleCount} of ${rows.length} records`;
    }

    function clearFilters() {
      document.getElementById('statusFilter').value = 'all';
      document.getElementById('stationFilter').value = 'all';
      document.getElementById('searchInput').value = '';
      filterTable();
    }

    // Initialize filters
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('statusFilter').addEventListener('change', filterTable);
      document.getElementById('stationFilter').addEventListener('change', filterTable);
      document.getElementById('searchInput').addEventListener('input', filterTable);
      
      // Set today's date as default for received date
      const today = new Date().toISOString().split('T')[0];
      const receivedDateField = document.getElementById('receivedDate');
      if (receivedDateField && !receivedDateField.value) {
        receivedDateField.value = today;
      }
    });
  </script>

  <style>
    .status-sent { border-left: 4px solid #ffc107; }
    .status-received { border-left: 4px solid #198754; }
    .history-card {
      border-radius: 12px;
      border: none;
      box-shadow: 0 2px 15px rgba(0,0,0,0.08);
    }
    .date-overdue {
      color: #dc3545;
      font-weight: bold;
    }
    .date-upcoming {
      color: #fd7e14;
      font-weight: bold;
    }
    .date-normal {
      color: #6c757d;
    }
    .optional-badge {
      font-size: 0.7rem;
      padding: 2px 6px;
      margin-left: 5px;
    }
    /* Style for action buttons */
    .btn-group-sm .btn {
      padding: 0.25rem 0.5rem;
      font-size: 0.875rem;
    }
    /* Make sure delete form doesn't break button group layout */
    .btn-group-sm form {
      margin: 0;
      padding: 0;
    }
  </style>
{% endblock %}