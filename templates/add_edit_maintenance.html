{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header bg-white py-3">
                    <h4 class="card-title mb-0">
                        <i class="fas fa-tools me-2"></i>{{ action }} Maintenance Record
                    </h4>
                </div>
                <div class="card-body">
                    <form method="POST" id="maintenanceForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Device Type *</label>
                                <select class="form-select" name="device_type" required id="deviceType">
                                    <option value="">Select Device Type</option>
                                    <option value="computer" {% if record and record.device_type == 'computer' %}selected{% endif %}>Computer</option>
                                    <option value="printer" {% if record and record.device_type == 'printer' %}selected{% endif %}>Printer</option>
                                </select>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Station *</label>
                                <select class="form-select" name="station_id" required id="stationSelect">
                                    <option value="">Select Station</option>
                                    {% for station in stations %}
                                    <option value="{{ station.id }}" {% if record and record.station_id == station.id %}selected{% endif %}>
                                        {{ station.name }} - {{ station.location }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Device *</label>
                            <select class="form-select" name="device_id" required id="deviceSelect">
                                <option value="">Select a device first</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Issue Description *</label>
                            <textarea class="form-control" name="issue_description" rows="4" 
                                      placeholder="Describe the issue in detail..." required>{% if record %}{{ record.issue_description }}{% endif %}</textarea>
                        </div>

                        <!-- New Field for Resolution Details -->
                        <div class="mb-3" id="resolutionField" style="display: none;">
                            <label class="form-label">Resolution Details * <small class="text-muted">(Required when status is Resolved)</small></label>
                            <textarea class="form-control" name="resolution_details" id="resolutionDetails" rows="3" 
                                      placeholder="Describe what was done to resolve the issue...">{% if record and record.resolution_details %}{{ record.resolution_details }}{% endif %}</textarea>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Technician *</label>
                                <input type="text" class="form-control" name="technician" 
                                       value="{% if record %}{{ record.technician }}{% endif %}" 
                                       placeholder="Enter technician name" required>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Status *</label>
                                <select class="form-select" name="status" required id="statusSelect">
                                    <option value="pending" {% if record and record.status == 'pending' %}selected{% endif %}>Pending</option>
                                    <option value="in_progress" {% if record and record.status == 'in_progress' %}selected{% endif %}>In Progress</option>
                                    <option value="resolved" {% if record and record.status == 'resolved' %}selected{% endif %}>Resolved</option>
                                </select>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Date Reported *</label>
                                <input type="date" class="form-control" name="date_reported" 
                                       value="{% if record %}{{ record.date_reported.strftime('%Y-%m-%d') }}{% else %}{{ today }}{% endif %}" required>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Date Resolved</label>
                                <input type="date" class="form-control" name="date_resolved" id="dateResolved"
                                       value="{% if record and record.date_resolved %}{{ record.date_resolved.strftime('%Y-%m-%d') }}{% endif %}">
                            </div>
                        </div>

                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary" id="submitBtn">
                                <i class="fas fa-check-circle me-2"></i>{{ action }} Record
                            </button>
                            <a href="{{ url_for('admin.maintenance_records') }}" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-2"></i>Cancel
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const computers = {{ computers|tojson }};
    const printers = {{ printers|tojson }};
    const currentRecord = {{ record|tojson|default('{}') }};

    // Initialize resolution field based on current status
    function toggleResolutionField() {
        const statusSelect = document.getElementById('statusSelect');
        const resolutionField = document.getElementById('resolutionField');
        const dateResolved = document.getElementById('dateResolved');
        
        if (statusSelect.value === 'resolved') {
            resolutionField.style.display = 'block';
            // Auto-fill date resolved with today if empty
            if (!dateResolved.value) {
                const today = new Date().toISOString().split('T')[0];
                dateResolved.value = today;
            }
        } else {
            resolutionField.style.display = 'none';
        }
    }

    // Show prompt when changing to resolved status
    document.getElementById('statusSelect').addEventListener('change', function() {
        const resolutionField = document.getElementById('resolutionField');
        const resolutionDetails = document.getElementById('resolutionDetails');
        
        if (this.value === 'resolved') {
            // Show the resolution field
            resolutionField.style.display = 'block';
            
            // Prompt user if resolution details are empty
            if (!resolutionDetails.value.trim()) {
                setTimeout(() => {
                    resolutionDetails.focus();
                    alert('Please enter resolution details since you marked this as resolved.');
                }, 100);
            }
        } else {
            resolutionField.style.display = 'none';
        }
    });

    // Validate form before submission
    document.getElementById('maintenanceForm').addEventListener('submit', function(e) {
        const status = document.getElementById('statusSelect').value;
        const resolutionDetails = document.getElementById('resolutionDetails');
        
        if (status === 'resolved') {
            if (!resolutionDetails.value.trim()) {
                e.preventDefault();
                alert('Resolution details are required when status is set to Resolved.');
                resolutionDetails.focus();
                return false;
            }
        }
        
        return true;
    });

    // Function to filter devices by station
    function filterDevicesByStation(stationId, deviceType) {
        const deviceSelect = document.getElementById('deviceSelect');
        deviceSelect.innerHTML = '<option value="">Select a device</option>';
        
        const devices = deviceType === 'computer' ? computers : printers;
        
        const filteredDevices = devices.filter(device => {
            const possibleStationProps = ['station_id', 'stationid', 'station', 'stationId'];
            let deviceStationId = null;
            
            for (const prop of possibleStationProps) {
                if (device[prop] !== undefined) {
                    deviceStationId = device[prop];
                    break;
                }
            }
            
            if (deviceStationId === null) {
                return false;
            }
            
            const deviceStationNum = parseInt(deviceStationId);
            const selectedStationNum = parseInt(stationId);
            
            return deviceStationNum === selectedStationNum;
        });

        filteredDevices.forEach(device => {
            const option = document.createElement('option');
            option.value = device.id;
            option.textContent = device.name || device.device_name || 'Unnamed Device';
            if (currentRecord && currentRecord.device_id == device.id && currentRecord.device_type == deviceType) {
                option.selected = true;
            }
            deviceSelect.appendChild(option);
        });

        if (filteredDevices.length === 0) {
            const option = document.createElement('option');
            option.value = "";
            option.textContent = "No devices found in this station";
            option.disabled = true;
            deviceSelect.appendChild(option);
        }
    }

    document.getElementById('deviceType').addEventListener('change', function() {
        const stationSelect = document.getElementById('stationSelect');
        const stationId = stationSelect.value;
        
        if (stationId) {
            filterDevicesByStation(stationId, this.value);
        } else {
            const deviceSelect = document.getElementById('deviceSelect');
            deviceSelect.innerHTML = '<option value="">Select a station first</option>';
        }
    });

    document.getElementById('stationSelect').addEventListener('change', function() {
        const deviceType = document.getElementById('deviceType').value;
        const stationId = this.value;
        
        if (deviceType && stationId) {
            filterDevicesByStation(stationId, deviceType);
        } else if (!deviceType) {
            const deviceSelect = document.getElementById('deviceSelect');
            deviceSelect.innerHTML = '<option value="">Select device type first</option>';
        }
    });

    // Initialize on page load
    window.addEventListener('DOMContentLoaded', function() {
        toggleResolutionField();
        
        if (currentRecord && currentRecord.device_type && currentRecord.station_id) {
            document.getElementById('deviceType').dispatchEvent(new Event('change'));
        }
    });
</script>
{% endblock %}