<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Stock Item Details - Najmi International</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="IT Inventory Management System">
  
  <style>
    /* ALL CSS FROM BASE.HTML + view_stock_item custom CSS merged */
    :root {
      --primary-blue: #1e3a8a;
      --primary-light: #3b82f6;
      --accent-blue: #0ea5e9;
      --success-green: #10b981;
      --warning-amber: #f59e0b;
      --danger-red: #ef4444;
      --dark-bg: #0f172a;
      --card-bg: #ffffff;
      --body-bg: #f8fafc;
      --border-gray: #e2e8f0;
      --text-dark: #1e293b;
      --text-light: #64748b;
      --primary-gradient: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
      --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --card-shadow-hover: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
    
    body { 
      font-family: system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
      background-color: var(--body-bg);
      color: var(--text-dark);
      margin: 0;
      padding: 0;
      min-height: 100vh;
    }
    
    .navbar {
      background-color: var(--dark-bg);
      position: sticky;
      top: 0;
      z-index: 1000;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      padding: 0.75rem 0;
    }
    
    .navbar-brand {
      font-weight: 700;
      font-size: 1.25rem;
      color: white !important;
      transition: opacity 0.3s ease;
    }
    
    .navbar-brand:hover { opacity: 0.9; }
    
    .nav-link {
      color: rgba(255, 255, 255, 0.9) !important;
      font-weight: 500;
      padding: 0.5rem 1rem !important;
      border-radius: 6px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      margin: 0 0.25rem;
    }
    
    .nav-link:hover {
      background: rgba(255, 255, 255, 0.1);
      color: white !important;
      transform: translateY(-2px);
    }
    
    .main-content {
      padding: 2rem 0;
      min-height: calc(100vh - 76px);
      animation: fadeIn 0.6s ease-out;
    }
    
    .card {
      border: 1px solid var(--border-gray);
      border-radius: 10px;
      background: var(--card-bg);
      box-shadow: var(--card-shadow);
      margin-bottom: 1.5rem;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      overflow: hidden;
    }
    
    .card:hover {
      box-shadow: var(--card-shadow-hover);
      transform: translateY(-5px);
      border-color: var(--primary-light);
    }
    
    .card-header {
      background: var(--primary-gradient);
      color: white;
      border-bottom: none;
      padding: 1.25rem 1.5rem;
      font-weight: 600;
      position: relative;
      overflow: hidden;
    }
    
    .card-body { padding: 1.5rem; }
    
    .btn {
      font-weight: 600;
      padding: 0.6rem 1.5rem;
      border-radius: 8px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border: 2px solid transparent;
    }
    
    .btn-primary {
      background: var(--primary-gradient);
      color: white;
    }
    
    .btn-primary:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 20px rgba(30, 58, 138, 0.2);
    }
    
    .btn-outline-primary {
      color: var(--primary-light);
      border-color: var(--primary-light);
      background: transparent;
    }
    
    .btn-outline-primary:hover {
      background: var(--primary-light);
      color: white;
      transform: translateY(-3px);
    }
    
    .table {
      background: var(--card-bg);
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }
    
    .table th {
      background: #f8fafc;
      color: var(--text-dark);
      font-weight: 600;
      padding: 1rem;
      border-bottom: 2px solid var(--border-gray);
    }
    
    .table td {
      padding: 1rem;
      border-color: var(--border-gray);
    }
    
    .badge {
      font-weight: 600;
      padding: 0.5em 0.8em;
      border-radius: 6px;
    }
    
    .badge-primary { background: var(--primary-gradient); }
    
    .alert {
      border: none;
      border-radius: 8px;
      padding: 1rem 1.25rem;
      margin-bottom: 1rem;
    }
    
    /* Custom styles from view_stock_item.html */
    .status-indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 8px;
    }
    .status-in-stock { background: #10b981; }
    .status-sent { background: #3b82f6; }
    .status-used { background: #f59e0b; }
    
    .info-card { border-left: 4px solid #4299e1; }
    .action-card { border-left: 4px solid #ed64a6; }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @media (max-width: 768px) {
      .main-content { padding: 1.5rem 0; }
      .card { margin-bottom: 1rem; }
      .btn { padding: 0.5rem 1rem; }
    }
  </style>
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body>
<!-- Navbar from base.html -->
<nav class="navbar navbar-expand-lg navbar-dark">
  <div class="container">
    <a class="navbar-brand" href="#">
      <i class="fas fa-server me-2"></i>
      IT Inventory System
    </a>
    
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" role="button" 
             data-bs-toggle="dropdown" aria-expanded="false">
            <i class="fas fa-user-circle me-2"></i>
            User
          </a>
          <ul class="dropdown-menu dropdown-menu-end">
            <li><span class="dropdown-item-text small text-muted">Role: Admin</span></li>
            <li><hr class="dropdown-divider"></li>
            <li>
              <a class="dropdown-item" href="#">
                <i class="fas fa-sign-out-alt me-2"></i>Logout
              </a>
            </li>
          </ul>
        </li>
      </ul>
    </div>
  </div>
</nav>

<!-- Main Content from your view_stock_item.html -->
<div class="container main-content">
  <!-- YOUR ACTUAL CONTENT - KEEP ALL YOUR JINJA2 VARIABLES -->
  <div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1">
                <i class="fas fa-box me-2 text-primary"></i>Stock Item Details
            </h2>
            <p class="text-muted mb-0">View and manage stock item information</p>
        </div>
        <div class="d-flex gap-2">
            <a href="{{ url_for('admin.stock_management') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i>Back
            </a>
        </div>
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- Item Details -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm info-card">
                <div class="card-header bg-white border-0 py-3 d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0 text-dark">
                        <i class="fas fa-info-circle me-2"></i>Item Information
                    </h5>
                    <div class="d-flex gap-2">
                        {% if item.quantity > 0 and item.status == 'In Stock' %}
                        <button type="button" class="btn btn-outline-info btn-sm" data-bs-toggle="modal" data-bs-target="#updateStatusModal"
                                onclick="setStatusData('{{ item.id }}', '{{ item.item_name }}', '{{ item.item_type }}')">
                            <i class="fas fa-paper-plane me-1"></i>Send/Use Items
                        </button>
                        {% endif %}
                        
                        <button type="button" class="btn btn-outline-warning btn-sm" data-bs-toggle="modal" data-bs-target="#editStockModal"
                                onclick="setEditStockData('{{ item.id }}', '{{ item.item_name }}', '{{ item.item_type }}', '{{ item.quantity }}', '{{ item.supplier or "" }}', '{{ item.model_number or "" }}', '{{ item.compatible_with or "" }}', '{{ item.notes or "" }}', '{% if item.purchase_date %}{{ item.purchase_date.strftime("%Y-%m-%d") }}{% endif %}')">
                            <i class="fas fa-edit me-1"></i>Edit
                        </button>
                        
                        <!-- New code (shows always) -->
<button type="button" class="btn btn-outline-success btn-sm" data-bs-toggle="modal" data-bs-target="#restockModal"
        onclick="setRestockData('{{ item.id }}', '{{ item.item_name }}', '{{ item.quantity }}')">
    <i class="fas fa-plus-circle me-1"></i>Restock
</button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <table class="table table-borderless">
                                <tr>
                                    <th width="40%">Item Name:</th>
                                    <td>
                                        <strong>{{ item.item_name }}</strong>
                                        {% if item.model_number %}
                                        <div class="text-muted small">{{ item.model_number }}</div>
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <th>Item Type:</th>
                                    <td>
                                        <span class="badge {% if item.item_type == 'Toner' %}bg-primary{% else %}bg-secondary{% endif %}">
                                            {{ item.item_type }}
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <th>Quantity:</th>
                                    <td>
                                        <span class="badge {% if item.quantity <= 2 %}bg-danger{% elif item.quantity <= 5 %}bg-warning{% else %}bg-success{% endif %}">
                                            {{ item.quantity }} in stock
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <th>Status:</th>
                                    <td>
                                        {% if item.status == 'In Stock' %}
                                        <span class="status-indicator status-in-stock"></span>In Stock
                                        {% elif item.status == 'Sent' %}
                                        <span class="status-indicator status-sent"></span>Sent
                                        {% elif item.status == 'Used' %}
                                        <span class="status-indicator status-used"></span>Used
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <th>Supplier:</th>
                                    <td>{{ item.supplier or 'N/A' }}</td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <table class="table table-borderless">
                                <tr>
                                    <th width="40%">Purchase Date:</th>
                                    <td>{{ item.purchase_date.strftime('%Y-%m-%d') if item.purchase_date else 'N/A' }}</td>
                                </tr>
                                <tr>
                                    <th>Compatible With:</th>
                                    <td>{{ item.compatible_with or 'N/A' }}</td>
                                </tr>
                                
                                {% if item.status == 'Sent' %}
                                <tr>
                                    <th>Sent to Station:</th>
                                    <td>{{ item.sent_to_station_name or 'N/A' }}</td>
                                </tr>
                                <tr>
                                    <th>Date Sent:</th>
                                    <td>{{ item.sent_date.strftime('%Y-%m-%d') if item.sent_date else 'N/A' }}</td>
                                </tr>
                                {% endif %}
                                
                                {% if item.status == 'Used' %}
                                <tr>
                                    <th>Used for Printer:</th>
                                    <td>{{ item.used_for_printer or 'N/A' }}</td>
                                </tr>
                                <tr>
                                    <th>Used at Station:</th>
                                    <td>{{ item.used_at_station_name or 'N/A' }}</td>
                                </tr>
                                <tr>
                                    <th>Date Used:</th>
                                    <td>{{ item.used_date.strftime('%Y-%m-%d') if item.used_date else 'N/A' }}</td>
                                </tr>
                                {% endif %}
                                
                                <tr>
                                    <th>Created:</th>
                                    <td>{{ item.created_at.strftime('%Y-%m-%d %H:%M') if item.created_at else 'N/A' }}</td>
                                </tr>
                                <tr>
                                    <th>Last Updated:</th>
                                    <td>{{ item.updated_at.strftime('%Y-%m-%d %H:%M') if item.updated_at else 'N/A' }}</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    
                    {% if item.notes %}
                    <div class="row mt-3">
                        <div class="col-12">
                            <h6 class="text-muted mb-2">Notes:</h6>
                            <div class="card bg-light">
                                <div class="card-body py-2">
                                    {{ item.notes|replace('\n', '<br>')|safe }}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if item.status == 'Sent' and item.sent_notes %}
                    <div class="row mt-3">
                        <div class="col-12">
                            <h6 class="text-muted mb-2">Sent Notes:</h6>
                            <div class="card bg-light">
                                <div class="card-body py-2">
                                    {{ item.sent_notes|replace('\n', '<br>')|safe }}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if item.status == 'Used' and item.usage_notes %}
                    <div class="row mt-3">
                        <div class="col-12">
                            <h6 class="text-muted mb-2">Usage Notes:</h6>
                            <div class="card bg-light">
                                <div class="card-body py-2">
                                    {{ item.usage_notes|replace('\n', '<br>')|safe }}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- History Section Removed -->
    <!-- The entire History card section has been deleted -->

  </div>
</div>

<!-- ALL YOUR MODALS (Update Status, Edit Stock, Restock) -->
<!-- Update Status Modal -->
<div class="modal fade" id="updateStatusModal" tabindex="-1" aria-labelledby="updateStatusModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="updateStatusModalLabel">
                    <i class="fas fa-exchange-alt me-2"></i>Update Stock Status
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('admin.update_stock_status') }}" method="POST">
                <input type="hidden" id="statusItemId" name="stock_item_id">
                <input type="hidden" id="currentQuantity" name="current_quantity" value="{{ item.quantity }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <p class="mb-2">Item: <strong id="statusItemName"></strong></p>
                        <p class="mb-1">Type: <span class="badge bg-primary" id="statusItemType"></span></p>
                        <p class="mb-3">Available: <span class="badge bg-success" id="availableQuantity">{{ item.quantity }}</span> units</p>
                    </div>
                    
                    <!-- Quantity Selector for Sending -->
                    <div class="mb-3" id="quantitySelector">
                        <label for="sendQuantity" class="form-label">Quantity to Send/Use *</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="sendQuantity" name="send_quantity" 
                                   min="1" max="{{ item.quantity }}" value="1" required>
                            <span class="input-group-text">of {{ item.quantity }} available</span>
                        </div>
                        <div class="form-text">Select how many units you want to send/use</div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Update Status To:</label>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="radio" name="status" id="statusSent" value="sent" checked>
                            <label class="form-check-label" for="statusSent">
                                <span class="status-indicator status-sent"></span> Sent to Station
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="status" id="statusUsed" value="used">
                            <label class="form-check-label" for="statusUsed">
                                <span class="status-indicator status-used"></span> Used
                            </label>
                        </div>
                    </div>
                    
                    <div id="sentDetails">
                        <div class="mb-3">
                            <label for="sentToStation" class="form-label">Sent to Station</label>
                            <select class="form-select" id="sentToStation" name="sent_to_station">
                                <option value="">Select Station</option>
                                {% for station in stations %}
                                <option value="{{ station.id }}">{{ station.name }} ({{ station.location }})</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="sentDate" class="form-label">Date Sent</label>
                            <input type="date" class="form-control" id="sentDate" name="sent_date" value="{{ today }}">
                        </div>
                        <div class="mb-3">
                            <label for="sentNotes" class="form-label">Notes</label>
                            <textarea class="form-control" id="sentNotes" name="sent_notes" rows="2" placeholder="Any notes about sending..."></textarea>
                        </div>
                    </div>
                    
                    <div id="usedDetails" style="display: none;">
                        <div class="mb-3">
                            <label for="usedForPrinter" class="form-label">Used for Printer</label>
                            <input type="text" class="form-control" id="usedForPrinter" name="used_for_printer" placeholder="Printer model or name">
                        </div>
                        <div class="mb-3">
                            <label for="usedAtStation" class="form-label">Used at Station</label>
                            <select class="form-select" id="usedAtStation" name="used_at_station">
                                <option value="">Select Station</option>
                                {% for station in stations %}
                                <option value="{{ station.id }}">{{ station.name }} ({{ station.location }})</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="usedDate" class="form-label">Date Used</label>
                            <input type="date" class="form-control" id="usedDate" name="used_date" value="{{ today }}">
                        </div>
                        <div class="mb-3">
                            <label for="usageNotes" class="form-label">Usage Notes</label>
                            <textarea class="form-control" id="usageNotes" name="usage_notes" rows="2" placeholder="Any notes about the usage..."></textarea>
                        </div>
                    </div>
                    
                    <!-- Status option for remaining items -->
                    <div class="mb-3">
                        <label for="remainingAction" class="form-label">Remaining Items Status</label>
                        <select class="form-select" id="remainingAction" name="remaining_action">
                            <option value="keep_in_stock">Keep remaining items "In Stock"</option>
                            <option value="update_all">Update all items to selected status</option>
                        </select>
                        <div class="form-text" id="remainingStatusText">
                            Remaining {{ item.quantity - 1 }} items will stay as "In Stock"
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Status</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Stock Item Modal -->
<div class="modal fade" id="editStockModal" tabindex="-1" aria-labelledby="editStockModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="editStockModalLabel">
                    <i class="fas fa-edit me-2"></i>Edit Stock Item
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('admin.edit_stock_item') }}" method="POST">
                <input type="hidden" id="editStockItemId" name="stock_item_id">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editItemName" class="form-label">Item Name *</label>
                            <input type="text" class="form-control" id="editItemName" name="item_name" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editItemType" class="form-label">Item Type *</label>
                            <select class="form-select" id="editItemType" name="item_type" required>
                                <option value="Toner">Toner</option>
                                <option value="Ink Cartridge">Ink Cartridge</option>
                                <option value="Cable">Cable</option>
                                <option value="Adapter">Adapter</option>
                                <option value="Battery">Battery</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="editQuantity" class="form-label">Quantity *</label>
                            <input type="number" class="form-control" id="editQuantity" name="quantity" min="1" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="editPurchaseDate" class="form-label">Purchase Date</label>
                            <input type="date" class="form-control" id="editPurchaseDate" name="purchase_date">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="editSupplier" class="form-label">Supplier</label>
                            <input type="text" class="form-control" id="editSupplier" name="supplier">
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editModelNumber" class="form-label">Model Number</label>
                            <input type="text" class="form-control" id="editModelNumber" name="model_number">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editCompatibleWith" class="form-label">Compatible With</label>
                            <input type="text" class="form-control" id="editCompatibleWith" name="compatible_with">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editNotes" class="form-label">Notes</label>
                        <textarea class="form-control" id="editNotes" name="notes" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Item</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Restock Modal - UPDATED WITH PURCHASE DATE -->
<div class="modal fade" id="restockModal" tabindex="-1" aria-labelledby="restockModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="restockModalLabel">
                    <i class="fas fa-plus-circle me-2"></i>Restock Item
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('admin.restock_item', item_id=item.id) }}" method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <p class="mb-2">Item: <strong id="restockItemName"></strong></p>
                        <p class="mb-3">Current Quantity: <span class="badge bg-info" id="currentQuantity"></span></p>
                    </div>
                    <div class="mb-3">
                        <label for="additionalQuantity" class="form-label">Additional Quantity *</label>
                        <input type="number" class="form-control" name="quantity" min="1" value="1" required>
                    </div>
                    <!-- ADDED PURCHASE DATE FIELD -->
                    <div class="mb-3">
                        <label for="purchaseDate" class="form-label">Purchase Date</label>
                        <input type="date" class="form-control" id="purchaseDate" name="purchase_date" value="{{ today }}">
                        <small class="text-muted">When was this stock purchased? (Optional)</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add to Stock</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>

<!-- Your JavaScript from view_stock_item.html -->
<script>
function setStatusData(itemId, itemName, itemType) {
    console.log("Setting status data:", itemId, itemName, itemType);
    document.getElementById('statusItemId').value = itemId;
    document.getElementById('statusItemName').textContent = itemName;
    document.getElementById('statusItemType').textContent = itemType;
    
    // Get current quantity from the page
    const currentQty = parseInt("{{ item.quantity }}");
    const sendQtyInput = document.getElementById('sendQuantity');
    const availableBadge = document.getElementById('availableQuantity');
    const qtySpan = document.querySelector('.input-group-text');
    
    // Update all quantity references
    if (sendQtyInput) {
        sendQtyInput.max = currentQty;
        sendQtyInput.value = Math.min(1, currentQty);
    }
    if (availableBadge) {
        availableBadge.textContent = currentQty;
    }
    if (qtySpan) {
        qtySpan.textContent = `of ${currentQty} available`;
    }
    
    // Update remaining status text
    updateRemainingStatusText();
}

function setEditStockData(itemId, itemName, itemType, quantity, supplier, modelNumber, compatibleWith, notes, purchaseDate) {
    console.log("Setting edit data");
    document.getElementById('editStockItemId').value = itemId;
    document.getElementById('editItemName').value = itemName || '';
    document.getElementById('editItemType').value = itemType || '';
    document.getElementById('editQuantity').value = quantity || '';
    document.getElementById('editSupplier').value = supplier || '';
    document.getElementById('editModelNumber').value = modelNumber || '';
    document.getElementById('editCompatibleWith').value = compatibleWith || '';
    document.getElementById('editNotes').value = notes || '';
    document.getElementById('editPurchaseDate').value = purchaseDate || '';
}

function setRestockData(itemId, itemName, quantity) {
    console.log("Setting restock data");
    document.getElementById('restockItemName').textContent = itemName;
    document.getElementById('currentQuantity').textContent = quantity;
    
    // Set today's date in the purchase date field
    const today = new Date().toISOString().split('T')[0];
    const purchaseDateInput = document.getElementById('purchaseDate');
    if (purchaseDateInput) {
        purchaseDateInput.value = today;
    }
}

// Function to update the remaining status text
function updateRemainingStatusText() {
    const sendQtyInput = document.getElementById('sendQuantity');
    const remainingAction = document.getElementById('remainingAction');
    const statusText = document.getElementById('remainingStatusText');
    
    if (!sendQtyInput || !remainingAction || !statusText) return;
    
    const sendQty = parseInt(sendQtyInput.value) || 1;
    const currentQty = parseInt("{{ item.quantity }}");
    const remaining = currentQty - sendQty;
    
    if (remainingAction.value === 'keep_in_stock') {
        statusText.textContent = `Remaining ${remaining} item(s) will stay as "In Stock"`;
    } else {
        const statusRadio = document.querySelector('input[name="status"]:checked');
        const status = statusRadio ? (statusRadio.value === 'sent' ? 'Sent' : 'Used') : 'Sent';
        statusText.textContent = `All ${currentQty} items will be marked as "${status}"`;
    }
}

// Handle modal toggle
document.addEventListener('DOMContentLoaded', function() {
    const sentRadio = document.getElementById('statusSent');
    const usedRadio = document.getElementById('statusUsed');
    const sentDetails = document.getElementById('sentDetails');
    const usedDetails = document.getElementById('usedDetails');
    const sendQtyInput = document.getElementById('sendQuantity');
    const remainingAction = document.getElementById('remainingAction');
    
    // Set today's date for all date inputs when page loads
    const today = new Date().toISOString().split('T')[0];
    
    // Set today's date for purchase date input
    const purchaseDateInput = document.getElementById('purchaseDate');
    if (purchaseDateInput) {
        purchaseDateInput.value = today;
    }
    
    // Also set for other date inputs
    const otherDateInputs = ['sentDate', 'usedDate', 'editPurchaseDate'];
    otherDateInputs.forEach(id => {
        const input = document.getElementById(id);
        if (input && !input.value) {
            input.value = today;
        }
    });
    
    // Handle status radio buttons
    if (sentRadio && usedRadio) {
        sentRadio.addEventListener('change', function() {
            if (this.checked) {
                sentDetails.style.display = 'block';
                usedDetails.style.display = 'none';
                updateRemainingStatusText();
            }
        });
        
        usedRadio.addEventListener('change', function() {
            if (this.checked) {
                sentDetails.style.display = 'none';
                usedDetails.style.display = 'block';
                updateRemainingStatusText();
            }
        });
    }
    
    // Handle quantity change
    if (sendQtyInput) {
        sendQtyInput.addEventListener('input', function() {
            // Ensure quantity is within bounds
            const maxQty = parseInt(this.max);
            const value = parseInt(this.value) || 1;
            
            if (value > maxQty) {
                this.value = maxQty;
            } else if (value < 1) {
                this.value = 1;
            }
            
            updateRemainingStatusText();
        });
    }
    
    // Handle remaining action change
    if (remainingAction) {
        remainingAction.addEventListener('change', function() {
            updateRemainingStatusText();
        });
    }
});
</script>
</body>
</html>