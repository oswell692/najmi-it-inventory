{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">
                {% if action == 'Edit' %}Update{% else %}Add{% endif %} Router
            </h5>
        </div>
        <div class="card-body">
            <form method="post" enctype="multipart/form-data">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Router Name *</label>
                        <input type="text" class="form-control" name="router_name" 
                               value="{{ router.name if router else '' }}" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Station Location *</label>
                        <select class="form-select" name="station_id" required>
                            <option value="">Select Station</option>
                            {% for station in stations %}
                            <option value="{{ station.id }}" 
                                {% if router and router.station_id == station.id %}selected{% endif %}>
                                {{ station.name }} - {{ station.location }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Brand</label>
                        <input type="text" class="form-control" name="brand" 
                               value="{{ router.brand if router else '' }}" 
                               placeholder="e.g., Cisco, TP-Link, MikroTik">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Model</label>
                        <input type="text" class="form-control" name="model" 
                               value="{{ router.model if router else '' }}" 
                               placeholder="e.g., WR840N, Archer C7">
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">IP Address</label>
                        <input type="text" class="form-control" name="ip_address" 
                               value="{{ router.ip_address if router else '' }}" 
                               placeholder="e.g., 192.168.1.1">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Serial Number</label>
                        <input type="text" class="form-control" name="serial_number" 
                               value="{{ router.serial_number if router else '' }}">
                    </div>
                </div>

                <!-- ADD USERNAME AND PASSWORD FIELDS -->
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Admin Username</label>
                        <input type="text" class="form-control" name="username" 
                               value="{{ router.username if router else 'admin' }}" 
                               placeholder="Default: admin">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Admin Password</label>
                        <input type="password" class="form-control" name="password" 
                               value="{{ router.password if router else '' }}" 
                               placeholder="Router admin password">
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Status</label>
                        <select class="form-select" name="status">
                            <option value="active" {% if router and router.status=='active' %}selected{% endif %}>Active</option>
                            <option value="maintenance" {% if router and router.status=='maintenance' %}selected{% endif %}>Maintenance</option>
                            <option value="offline" {% if router and router.status=='offline' %}selected{% endif %}>Offline</option>
                            <option value="backup" {% if router and router.status=='backup' %}selected{% endif %}>Backup</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Purchase Date</label>
                        <input type="date" class="form-control" name="purchase_date" 
                               value="{{ router.purchase_date if router and router.purchase_date else '' }}">
                    </div>
                </div>

                <!-- Image Upload Section -->
                <div class="mb-3">
                    <label class="form-label">Router Images (Optional - Max 5 images)</label>
                    
                    <!-- Existing Images Display -->
                    <div id="existingImages" class="mb-3">
                        {% if action == 'Edit' and router and router.images %}
                            {% set existing_images = [] %}
                            {% if router.images %}
                                {% if router.images is string %}
                                    {% set existing_images = router.images|fromjson %}
                                {% else %}
                                    {% set existing_images = router.images %}
                                {% endif %}
                            {% endif %}
                            
                            {% for image_path in existing_images %}
                            <div class="existing-image-item mb-2 d-inline-block me-2 position-relative">
                                <img src="{{ url_for('static', filename=image_path) }}" alt="Router image" class="img-thumbnail" style="width: 150px; height: 100px; object-fit: cover;">
                                <button type="button" class="btn btn-danger btn-sm position-absolute top-0 end-0" onclick="removeExistingImage(this, '{{ image_path }}')">
                                    <i class="bi bi-x"></i>
                                </button>
                                <input type="hidden" name="existing_images" value="{{ image_path }}">
                            </div>
                            {% endfor %}
                        {% endif %}
                    </div>

                    <!-- New Image Upload -->
                    <div id="imageUploadArea">
                        <div class="image-upload-item mb-2">
                            <input type="file" name="router_images" class="form-control" accept="image/*" onchange="previewImage(this)">
                            <div class="image-preview mt-1"></div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-outline-primary btn-sm mt-2" onclick="addImageField()" id="addImageBtn">
                        <i class="bi bi-plus-circle"></i> Add Another Image
                    </button>
                    <small class="form-text text-muted">You can upload up to 5 images. Accepted formats: JPG, PNG, GIF</small>
                    
                    <!-- Hidden field to track deleted images -->
                    <input type="hidden" name="deleted_images" id="deletedImages" value="">
                </div>

                <div class="mb-3">
                    <label class="form-label">Notes</label>
                    <textarea class="form-control" name="notes" rows="3" 
                              placeholder="Any additional information about the router">{{ router.notes if router else '' }}</textarea>
                </div>

                <button type="submit" class="btn btn-success">
                    {% if action == 'Edit' %}Update{% else %}Add{% endif %} Router
                </button>
                <a href="{{ url_for('admin.view_routers') }}" class="btn btn-secondary">Cancel</a>
            </form>
        </div>
    </div>
</div>

<style>
.image-upload-item {
    position: relative;
}
.image-preview {
    max-width: 200px;
    max-height: 150px;
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 4px;
    display: none;
}
.image-preview img {
    max-width: 100%;
    max-height: 140px;
}
.remove-image {
    position: absolute;
    top: 0;
    right: 0;
    background: rgba(255,0,0,0.7);
    color: white;
    border: none;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    font-size: 12px;
    cursor: pointer;
}
.existing-image-item .btn {
    transform: translate(50%, -50%);
}
</style>

<script>
let imageCount = 1;
const maxImages = 5;
let deletedImages = [];

function addImageField() {
    if (imageCount < maxImages) {
        const imageUploadArea = document.getElementById('imageUploadArea');
        const newImageItem = document.createElement('div');
        newImageItem.className = 'image-upload-item mb-2';
        newImageItem.innerHTML = `
            <input type="file" name="router_images" class="form-control" accept="image/*" onchange="previewImage(this)">
            <button type="button" class="remove-image" onclick="removeImageField(this)">Ã—</button>
            <div class="image-preview mt-1"></div>
        `;
        imageUploadArea.appendChild(newImageItem);
        imageCount++;
        
        if (imageCount >= maxImages) {
            document.getElementById('addImageBtn').style.display = 'none';
        }
    }
}

function removeImageField(button) {
    const imageItem = button.parentElement;
    imageItem.remove();
    imageCount--;
    
    document.getElementById('addImageBtn').style.display = 'block';
    
    // Update image count based on actual fields
    const imageFields = document.querySelectorAll('.image-upload-item');
    imageCount = imageFields.length;
}

function previewImage(input) {
    const preview = input.parentElement.querySelector('.image-preview');
    
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        
        reader.onload = function(e) {
            preview.innerHTML = `<img src="${e.target.result}" alt="Preview">`;
            preview.style.display = 'block';
        }
        
        reader.readAsDataURL(input.files[0]);
    } else {
        preview.style.display = 'none';
        preview.innerHTML = '';
    }
}

function removeExistingImage(button, imagePath) {
    // Add to deleted images list
    deletedImages.push(imagePath);
    document.getElementById('deletedImages').value = JSON.stringify(deletedImages);
    
    // Remove from display
    const imageItem = button.closest('.existing-image-item');
    imageItem.remove();
    
    // Show notification
    showToast('Image marked for deletion. Save changes to confirm.');
}

function showToast(message) {
    // Create a simple toast notification
    const toast = document.createElement('div');
    toast.className = 'alert alert-info alert-dismissible fade show position-fixed';
    toast.style.top = '20px';
    toast.style.right = '20px';
    toast.style.zIndex = '1050';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(toast);
    
    // Auto remove after 3 seconds
    setTimeout(() => {
        if (toast.parentNode) {
            toast.remove();
        }
    }, 3000);
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Count existing images and adjust available slots
    const existingImages = document.querySelectorAll('.existing-image-item');
    const existingCount = existingImages.length;
    
    // Adjust available slots for new images
    imageCount = Math.max(imageCount, existingCount);
    
    // Hide add button if we're at max capacity
    if (existingCount + imageCount >= maxImages) {
        document.getElementById('addImageBtn').style.display = 'none';
    }
    
    // Initialize deleted images array
    deletedImages = [];
});
</script>
{% endblock %}